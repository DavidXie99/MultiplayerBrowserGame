<body style = "padding:0px; margin:0px">
    <div id = "gameWindow">
    </div>
</body>
<script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
<script src = "/socket.io/socket.io.js"></script>
<script>
    //Socket instance, initialized in create()
    var socket;

    //Initialize phaser game
    var game = new Phaser.Game(window.innerWidth * window.devicePixelRatio, window.innerHeight * window.devicePixelRatio, Phaser.AUTO, 'gameWindow', { preload: preload, create: create, update: update });

    //*Supposed* to resize the window, doesn't work that well
    window.addEventListener('resize', function(){
        game.scale.scaleMode = Phaser.ScaleManager.NO_SCALE;
        game.scale.setGameSize(window.innerWidth * window.devicePixelRatio, window.innerHeight * window.devicePixelRatio);
        console.log("resize " + window.innerHeight * window.devicePixelRatio);
    });


    //Keeps track of inputs
    var Inputs = {
        up: false,
        down: false,
        right: false,
        left: false,
    }


    //Player class
    var Player = function(id){
        var self = {};
        self.gameobject = game.add.sprite(250, 250, 'dude');
        self.gameobject.anchor.x = 0.5;
        self.gameobject.anchor.y = 0.5;
        self.ID = id;
        self.toDelete = false;
        self.thisPlayer  = false;
        self.targetX = 250;
        self.targetY = 250;
        self.targetAngle = 0;
        self.gameobject.scale.setTo(0.3);
        self.gameobject.anchor.x = 100.0/313;
        self.gameobject.anchor.y = 120.0/207;
        self.healthpoints = 100;

        Player.list[id] = self;
        
        return self;

    }
    Player.list = {};

    Player.thisPlayer;

    Player.initThisPlayer = function(id){
        Player.thisPlayer = Player(id);
        Player.thisPlayer.thisPlayer = true;
    }

    Player.initNewPlayer = function(id){
        console.log("Init new player with ID: " + id);
        var player = Player(id);
    }

    Player.onInitialJoinPopulatePlayers = function(data){
        for(var id in data){
            Player.initNewPlayer(id);
        }
        Player.updateAllTargetPositions(data);
    }

    Player.onDisconnect = function(id){
        Player.list[id].gameobject.kill();
        delete Player.list[id];
    }



    //Sets target positions and rotations for every player object based on server data
    Player.updateAllTargetStatuses = function(data){
        Player.updateAllTargetPositions(data);
        Player.updateOtherTargetAngles(data);
        Player.updateAllHealthPoints(data);
    }


    Player.updateAllHealthPoints = function(data){
        for (var id in data){
            Player.list[id].healhpoints = data[id].healthpoints; 
        }
    }

    Player.updateAllTargetPositions = function(data){
        for(var id in data){
            Player.list[id].targetX = data[id].position[0];
            Player.list[id].targetY = data[id].position[1];
        }
    }

    Player.updateOtherTargetAngles = function(data){
        for(var id in data){
            if(!Player.list[id].thisPlayer){
                Player.list[id].gameobject.targetAngle = data[id].angle;
            }
        }
    }

    //Handles the actual position updates
    Player.updateSelfRotation = function(){
            //Mouse rotation
            var x = game.camera.x + game.input.mousePointer.x;
            var y = game.camera.y+ game.input.mousePointer.y;
            var thisplayer = Player.thisPlayer;
            var absAngle = Math.abs(Math.atan((y-thisplayer.gameobject.y)/(x-thisplayer.gameobject.x))*180/Math.PI);
            if(x > thisplayer.gameobject.x && y > thisplayer.gameobject.y)
                thisplayer.gameobject.angle = absAngle;
            else if (x < thisplayer.gameobject.x && y > thisplayer.gameobject.y)
                thisplayer.gameobject.angle = -180 - absAngle;
            else if (x < thisplayer.gameobject.x && y < thisplayer.gameobject.y)
                thisplayer.gameobject.angle = -180 + absAngle;
            else
                thisplayer.gameobject.angle = -absAngle;
    }

    Player.updateAllRotations = function(){
        for(var id in Player.list){
            if(!Player.list[id].thisPlayer){
                Player.list[id].gameobject.angle = Player.list[id].gameobject.targetAngle;
            }
        }
        Player.updateSelfRotation();
    }


    Player.updateAllPositons = function(){
        for(var id in Player.list){
            Player.list[id].gameobject.x = Player.list[id].targetX;
            Player.list[id].gameobject.y = Player.list[id].targetY;
        }
    }

    Player.updateServer = function(){
        socket.emit('updateServerOnMainPlayer', {inputs: Inputs, angle: Player.thisPlayer.gameobject.angle});
        console.log("X: " + Player.thisPlayer.gameobject.x);
    }
    
    
    var Block = function(texture, position){
        self.gameobject = game.add.sprite(position[0], position[1], texture);
        self.gameobject.anchor.x = 0.5;
        self.gameobject.anchor.y = 0.5;
    }
    
    Block.makeMap = function(mapArray){
        for(var i = 0; i < mapArray.length; i++) {
            Block(mapArray[i].texture, mapArray[i].position);
        }
    }
    

    var Bullet = function(angle, position){
        var self = {};
        self.id = Math.random();
        self.maxspeed = 1200;
        self.gameobject = game.add.sprite(position[0],position[1], 'bullet');
        self.gameobject.anchor.x = 0.5;
        self.gameobject.anchor.y = 0.5;
        game.physics.p2.enable(self.gameobject);
        self.gameobject.body.angle = angle;
        self.gameobject.body.velocity.x = Math.cos(angle/180*Math.PI) * self.maxspeed;
        self.gameobject.body.velocity.y = Math.sin(angle/180*Math.PI) * self.maxspeed;
        self.timeAlive = 0;
        Bullet.list[self.id] = self;
    }

    Bullet.list = {};

    Bullet.destroyOldBullets = function(){
        for(var id in Bullet.list){
            if(Bullet.list[id].timeAlive > 30){
                Bullet.list[id].gameobject.kill();
                delete Bullet.list[id];
            } else{
                Bullet.list[id].timeAlive++;
            }
        }
    }

    Bullet.initNewBullet = function(data){
        Bullet(data.angle, data.position);
    }

    Bullet.requestServerForBullet = function(){
        var angle = Player.thisPlayer.gameobject.angle;
        var position = [Player.thisPlayer.gameobject.x, Player.thisPlayer.gameobject.y];
        console.log("Requesting bullet: " + angle + position[0] + position[1]);
        socket.emit('requestServerForBullet', {angle:angle, position:position});
    }

    //Main phaser functions

    //Loads assets
    function preload() {
        game.load.image('bullet', '/assets/bullet.png');
        game.load.image('dude', '/assets/player.png');
        game.load.image('block', '/assets/block.png');
        game.load.image('grass', '/assets/grass.png');
        game.load.image('tree', '/assets/tree.png');

        // LOADING TILESET ASSETS
        this.load.tilemap('map', '/assets/Maps/map.csv');
        this.load.image('tiles', '/assets/Maps/wood_tileset.png');
    }
    
    var scoreText;
    var healthpoints;
    var startGame =false;

    // Tileset Variables
    var map;
    var layer;

    //Initializes game
    function create() {
        map = game.add.tilemap('map', 64, 64);
        map.addTilesetImage('tiles');
        layer = map.createLayer(0);
        layer.resizeWorld();

        game.world.setBounds(0, 0, 1920, 1080);
        game.time.advancedTiming = true;
        game.stage.disableVisibilityChange = true;
        game.stage.backgroundColor = '#95BCC7';
        
        game.physics.startSystem(Phaser.Physics.P2JS);

        scoreText = game.add.text(16, 16, 'FPS: ', { fontSize: '32px', fill: '#000' });

        healthpoints = game.add.text(16, 45, 'Healthpoints: ', { fontSize: '32px', fill: '#000' });

        socket = io();
        socket.on('connect', function() {
            Player.initThisPlayer(socket.id)
            console.log("Socket: " + socket.id);
            socket.on('updateClientOnPlayers', Player.updateAllTargetStatuses);
            socket.on('newPlayer', Player.initNewPlayer);
            socket.on('onInitialJoinPopulatePlayers', Player.onInitialJoinPopulatePlayers);
            socket.on('playerDisconnect', Player.onDisconnect);
            socket.on('bulletCreate', Bullet.initNewBullet);
            socket.on('createMap', Block.makeMap);
            startGame = true;
            game.time.events.loop(100, Player.updateServer, this);


            //Handle key inputs
            document.onkeydown = function (ev) {
                if(ev.keyCode === 68){ //d
                    Inputs.right = true;
                } 
                else if(ev.keyCode === 83){ //s
                    Inputs.down = true;
                }
                else if(ev.keyCode === 65) { //a
                    Inputs.left = true;
                }
                else if(ev.keyCode === 87){ //w
                    Inputs.up = true;
                }
                Player.updateServer();
            }
            document.onkeyup = function (ev) {

                if(ev.keyCode === 68){ //d
                    Inputs.right = false;
                } 
                else if(ev.keyCode === 83){ //s
                    Inputs.down = false;
                }
                else if(ev.keyCode === 65) { //a
                    Inputs.left = false;
                }
                else if(ev.keyCode === 87){ //w
                    Inputs.up = false;
                }
                Player.updateServer();
            }

            document.onclick = function(){
                Bullet.requestServerForBullet();
            }
        });
    }
    

    //Main render loop
    function update(){
        if(startGame){
            scoreText.text = 'FPS: ' + game.time.fps;
            healthpoints.text = 'Healthpoints: ' + Player.thisPlayer.healthpoints;
            Player.updateAllPositons();
            Player.updateAllRotations();
            Bullet.destroyOldBullets();
        }
    }

</script>
